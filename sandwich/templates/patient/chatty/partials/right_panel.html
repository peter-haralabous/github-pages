{% extends "patient/chatty/partials/sidebar.html" %}

{% load lucide %}

{# djlint:off #}
{% block panel_id %}right-panel{% endblock panel_id %}
{# if the icon isn't a button it needs some additional padding #}
{% block header_icon %}<div class="pl-2">{% lucide "layout-grid" class="size-6" %}</div>{% endblock header_icon %}
{% block header_title %}Feed{% endblock header_title %}
{% block collapse_icon %}{% lucide "panel-right-close" class="size-6" %}{% endblock collapse_icon %}
{% block expand_icon %}{% lucide "panel-right-open" class="size-6" %}{% endblock expand_icon %}
{# djlint:on #}
{% block panel_content %}
  <div class="flex-1 overflow-y-auto p-4 space-y-6 relative"
       id="summary-content">
    {# Health Summary #}
    {% if health_summary_html %}
      <div class="card bg-base-200" id="summary-card">
        <div class="card-body p-4">
          <div class="flex items-start justify-between gap-2 mb-2">
            <div class="flex items-start gap-2">
              {% lucide "sparkles" class="size-5 text-primary mt-0.5 flex-shrink-0" id="summary-sparkle-icon" %}
              <h1 class="font-semibold text-sm">Health Summary</h1>
            </div>
            <button class="btn btn-ghost btn-xs hover:btn-primary refresh-summary-btn"
                    hx-post="{% url 'patients:regenerate_health_summary' patient_id=patient.id %}"
                    hx-target="#summary-card"
                    hx-swap="outerHTML"
                    hx-select="#summary-card"
                    hx-indicator="#summary-loading-overlay"
                    title="Regenerate summary">{% lucide "refresh-cw" class="size-3" %}</button>
          </div>
          <div class="text-sm prose prose-sm max-w-none health-summary-content"
               id="summary-prose">{{ health_summary_html|safe }}</div>
          <div class="flex items-center justify-between mt-3 pt-3 border-t border-base-300">
            <div class="text-xs text-base-content/50">Updated {{ health_summary.created_at|timesince }} ago</div>
            {% if health_summary.source_record_ids %}
              <div class="text-xs text-base-content/40">
                {{ health_summary.source_record_ids|length }} record{{ health_summary.source_record_ids|length|pluralize }}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% else %}
      {# Empty state #}
      <div class="card bg-base-200" id="summary-card">
        <div class="card-body flex flex-col items-center justify-center h-full text-center p-8">
          {% lucide "sparkles" class="size-12 text-base-content/20 mb-3" %}
          <p class="text-base-content/60 text-sm font-medium">No health summary yet</p>
          <p class="text-base-content/40 text-xs mt-1">Start chatting to add your health records</p>
        </div>
      </div>
    {% endif %}
    {# Loading overlay - positioned absolutely over the entire content area #}
    <div id="summary-loading-overlay"
         class="summary-loading-overlay absolute inset-0 bg-white/40 rounded-xl overflow-hidden pointer-events-none">
      <div class="text-center z-10 relative flex items-start justify-center pt-8">
        {% lucide "loader-circle" class="size-16 text-primary animate-spin" %}
      </div>
    </div>
  </div>
  {# Loading animation styles #}
  <style nonce="{{ request.csp_nonce }}">
    /* Hide overlay by default */
    .summary-loading-overlay {
      display: none;
      z-index: 10;
    }

    /* HTMX indicator - show when request is in progress */
    .summary-loading-overlay.htmx-request {
      display: flex !important;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }

    /* Health summary modern styling */
    .health-summary-content h3 {
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: oklch(var(--p));
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid oklch(var(--p) / 0.2);
    }

    .health-summary-content h3:first-child {
      margin-top: 0;
    }

    .health-summary-content p {
      line-height: 1.6;
      margin-bottom: 0.5rem;
      color: oklch(var(--bc) / 0.8);
    }

    .health-summary-content strong {
      color: oklch(var(--bc) / 0.9);
      font-weight: 600;
    }

    /* Make each bold label in patient info start on a new line */
    .health-summary-content h3:first-of-type+p strong:not(:first-of-type)::before {
      content: "";
      display: block;
      height: 0;
    }

    .health-summary-content ul {
      list-style: none;
      padding-left: 0;
      margin-top: 0.5rem;
    }

    .health-summary-content li {
      padding-left: 1.5rem;
      position: relative;
      margin-bottom: 0.5rem;
      line-height: 1.5;
      color: oklch(var(--bc) / 0.85);
    }

    .health-summary-content li:before {
      content: "â€¢";
      color: oklch(var(--p));
      font-weight: bold;
      position: absolute;
      left: 0.5rem;
    }

    /* Patient info definition list styling */
    .health-summary-content dl.patient-info-dl {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.5rem 1rem;
      margin: 0;
    }

    .health-summary-content dl.patient-info-dl dt {
      font-weight: 600;
      color: oklch(var(--bc) / 0.7);
      text-align: right;
    }

    .health-summary-content dl.patient-info-dl dd {
      margin: 0;
      color: oklch(var(--bc) / 0.9);
    }
  </style>
  {# Auto-refresh summary when new records are added via chat #}
  <div hx-get="{% url 'patients:patient_details' patient_id=patient.id %}"
       hx-trigger="refreshHealthSummary from:body"
       hx-target="#summary-card"
       hx-swap="outerHTML"
       hx-select="#summary-card"
       hx-indicator="#summary-loading-overlay"
       class="hidden"></div>
{% endblock panel_content %}
{% block collapsed_panel_content %}
  {# nothing here #}
{% endblock collapsed_panel_content %}
