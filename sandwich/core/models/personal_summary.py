from datetime import timedelta

from django.db import models
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from django_enum import EnumField

from sandwich.core.models.abstract import BaseModel
from sandwich.core.models.patient import Patient


class PersonalSummaryType(models.TextChoices):
    # Healthy Summary generated by AI from chat interface.
    HEALTH_SUMMARY = "health_summary", _("Health Summary")


class PersonalSummaryManager(models.Manager["PersonalSummary"]):
    def get_most_recent_health_summary_in_last_24hrs(self, patient: Patient) -> "PersonalSummary | None":
        """Return most recent health summary generated within the last 24-hrs.

        This is the Health Summary generated by AI, triggered by the patient via the chat interface.
        """
        cutoff_time = timezone.now() - timedelta(hours=24)
        return (
            self.filter(
                patient=patient,
                summary_type=PersonalSummaryType.HEALTH_SUMMARY,
                created_at__gte=cutoff_time,
            )
            .order_by("-created_at")
            .first()
        )


class PersonalSummary(BaseModel):
    patient = models.ForeignKey(Patient, on_delete=models.CASCADE, help_text="Patient this summary is about")
    body = models.TextField(blank=True, help_text="Generated HTML content")
    summary_type: models.Field[PersonalSummaryType, PersonalSummaryType] = EnumField(
        PersonalSummaryType,
        default=PersonalSummaryType.HEALTH_SUMMARY,
        help_text="The type of personal summary generated",
    )

    objects = PersonalSummaryManager()

    class Meta:
        verbose_name_plural = "PersonalSummaries"

    def __str__(self) -> str:
        return f"{self.get_summary_type_display()} - {self.patient.full_name}"
